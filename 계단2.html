<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2번째 장면</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #87CEEB; /* 하늘색 배경 */
        }
        .game-area {
            position: relative;
            width: 800px;
            height: 600px;
            border: 2px solid #000;
            background-color: #87CEEB;
            margin: 20px auto;
            overflow: hidden;
        }
        .character {
            position: absolute;
            width: 50px;
            height: 50px;
            background-color: red;
            left: 50px;
            bottom: 0;
            transition: left 0.1s, transform 0.2s; /* 좌우 이동 및 회전 애니메이션 */
        }
        .stairs {
            position: absolute;
            width: 100px;
            height: 150px;
            background-color: gray;
            right: 100px; /* 화면 우측에서 100px 떨어진 위치 */
            bottom: 0;
        }
        .box {
            position: absolute;
            width: 100px;
            height: 100px;
            background-color: yellow;
            bottom: 250px; /* 박스 위치를 250px로 낮춤 */
            left: 50%;
            transform: translateX(-50%); /* 수평 중앙 정렬 */
        }
    </style>
</head>
<body>
    <div class="game-area" id="gameArea">
        <div class="character" id="character"></div>
        <div class="stairs" id="stairs"></div>
        <div class="box" id="box"></div> <!-- 머리로 칠 수 있는 박스 -->
    </div>

    <!-- jQuery 라이브러리 -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function() {
            var $character = $('#character');
            var $gameArea = $('#gameArea');
            var $stairs = $('#stairs');
            var $box = $('#box');
            var hitCount = 0; // 박스에 닿은 횟수를 저장
            var boxHit = false; // 박스에 충돌했는지 여부

            var character = {
                x: 50,
                y: 0,
                width: 50,
                height: 50,
                velocityY: 0,
                isJumping: false,
                speed: 5,
                gravity: 1.5,
                maxFallSpeed: 10, // 낙하 속도 최대치
                jumpStrength: 30, // 점프 높이 증가
                facingRight: true // 캐릭터의 바라보는 방향 상태 추가 (true = 우측)
            };

            var keys = {
                left: false,
                right: false,
                up: false,
                down: false
            };

            var stair = {
                x: $gameArea.width() - parseInt($stairs.css('right')) - $stairs.width(), // 우측에서 위치를 계산
                y: parseInt($stairs.css('bottom')),
                width: $stairs.width(),
                height: $stairs.height()
            };

            // 키보드 입력 처리
            $(document).keydown(function(e) {
                switch(e.key) {
                    case "ArrowLeft":
                        keys.left = true;
                        break;
                    case "ArrowRight":
                        keys.right = true;
                        break;
                    case " ":
                        keys.up = true;
                        break;
                    case "ArrowDown":
                        keys.down = true;
                        break;
                }
            });

            $(document).keyup(function(e) {
                switch(e.key) {
                    case "ArrowLeft":
                        keys.left = false;
                        break;
                    case "ArrowRight":
                        keys.right = false;
                        break;
                    case " ":
                        keys.up = false;
                        break;
                    case "ArrowDown":
                        keys.down = false;
                        break;
                }
            });

            // 충돌 감지 함수 (계단)
            function checkCollisionWithStair(newX, newY) {
                return newX + character.width > stair.x &&
                       newX < stair.x + stair.width &&
                       newY < stair.y + stair.height &&
                       newY + character.height > stair.y;
            }

            // 캐릭터가 계단 위에 있는지 확인
            function onStair(newY) {
                return character.x + character.width > stair.x &&
                       character.x < stair.x + stair.width &&
                       newY <= stair.y + stair.height &&
                       newY >= stair.y;
            }

            // 박스 하단과 캐릭터 상단의 충돌 감지 (캐릭터 상단과 박스 하단이 부딪칠 때)
            function checkCollisionWithBox(newX, newY) {
                var boxBottom = $box.position().top + $box.height();
                var boxLeft = $box.position().left;
                var boxRight = boxLeft + $box.width();

                console.log("캐릭터 상단 y:", newY + character.height, "박스 하단:", boxBottom);

                return newX + character.width > boxLeft &&
                       newX < boxRight &&
                       newY + character.height >= boxBottom && // 캐릭터 상단이 박스 하단에 부딪칠 때
                       newY <= boxBottom;
            }

            // 게임 루프
            function gameLoop() {
                var newX = character.x;
                var newY = character.y;

                // 좌우 이동
                if (keys.left) {
                    newX = character.x - character.speed;
                    if (newX < 0) newX = 0; // 왼쪽 경계
                    character.x = newX;
                    if (character.facingRight) {
                        $character.css('transform', 'scaleX(-1)');
                        character.facingRight = false;
                    }
                }
                if (keys.right) {
                    newX = character.x + character.speed;
                    if (newX + character.width > $gameArea.width()) newX = $gameArea.width() - character.width; // 오른쪽 경계
                    character.x = newX;
                    if (!character.facingRight) {
                        $character.css('transform', 'scaleX(1)');
                        character.facingRight = true;
                    }
                }

                // 점프 처리
                if (keys.up && !character.isJumping) {
                    if (character.y === 0 || onStair(character.y)) {
                        character.isJumping = true;
                        character.velocityY = character.jumpStrength;
                    }
                }

                // 중력 적용 및 낙하 속도 처리
                if (character.isJumping) {
                    newY = character.y + character.velocityY;
                    character.velocityY -= character.gravity;

                    // 최고점 도달 후 하강
                    if (newY <= 0) {
                        newY = 0;
                        character.isJumping = false;
                        character.velocityY = 0;
                    }

                    // 계단 충돌 체크
                    if (checkCollisionWithStair(character.x, newY)) {
                        newY = stair.y + stair.height;
                        character.isJumping = false;
                        character.velocityY = 0;
                    }

                    // 박스 충돌 체크 (박스 하단과 캐릭터 상단이 부딪칠 때)
                    if (checkCollisionWithBox(character.x, newY) && !boxHit) {
                        boxHit = true; // 중복 점프 방지
                        hitCount++;
                        console.log("박스에 머리 충돌 횟수:", hitCount); // 충돌 횟수 출력
                        if (hitCount >= 3) {
                            alert("경고: 박스를 세 번 쳤습니다!");
                            hitCount = 0; // 초기화
                        }
                    }

                    character.y = newY;
                } else {
                    // 바닥 또는 계단 위에서 중력 적용
                    if (!onStair(newY) && character.y > 0) {
                        character.velocityY = Math.min(character.velocityY + character.gravity, character.maxFallSpeed);
                        newY = character.y - character.velocityY;
                        if (newY < 0) newY = 0; // 바닥에 닿으면 0으로 설정
                        character.y = newY;
                    }

                    // 계단 위에서 아래 방향키를 누를 때 경고창 띄우기
                    if (keys.down && onStair(character.y)) {
                        alert("메롱");
                        keys.down = false; // 경고창이 계속 뜨지 않도록 처리
                    }
                }

                // 박스와 충돌이 끝났을 때 boxHit을 초기화
                if (character.y > $box.position().top + $box.height()) {
                    boxHit = false;
                }

                // 화면에 캐릭터 위치 업데이트
                $character.css({
                    left: character.x + 'px',
                    bottom: character.y + 'px'
                });

                requestAnimationFrame(gameLoop);
            }

            // 게임 시작
            gameLoop();
        });
    </script>
</body>
</html>
